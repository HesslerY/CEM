%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                      外加场对PO电流贡献和遮蔽因子                         %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
load('MOM.mat');
load('PO.mat');
load('E_i.mat');
load('EH.mat');
%%
%PO区域外加场设置
center_k = (p_PO(Edge_PO(:,1),:)+p_PO(Edge_PO(:,2),:))/2;
E_inc_r_k = repmat(exp(-1j*k*center_k*k_i'),1,3).*repmat(Pol,Edg_PO_Total,1); %外加电场矢量极化表达 E_k Edg_PO_Total*3 
H_inc_r_k = 1/eta_*cross(repmat(k_i,Edg_PO_Total,1),E_inc_r_k);        %外加磁场矢量表达  H_k
%%
tic;
%遮蔽判断：
%外加场的遮蔽判断因子：
%自遮蔽判断
afa0 = n_i_PO*k_i';              %所有入射方向矢量与面元法矢作用(每一列即是对应一个角度下时，所有面片的遮蔽判断角)
sita_PO = afa0<=0;                %afa0<0的所有面元都置为1，afa0>=0的面元都被自身遮蔽，置为0
%PO-MOM遮蔽因子(考虑MOM区域面元对PO区域面元的遮蔽作用只要考虑那些自遮蔽判断被照亮的面片即遮蔽因子为1的)
sita_1 = find(sita_PO==1);
K1 = length(sita_1);             %用于循环判定次数（M――――K1）
Q = Center_PO(sita_1,:);         %取出PO区域自遮蔽判断未被遮蔽的面片的图心
for m = 1:T_NUM_MOM 
   CQ = Q-repmat(C_MOM(m,:),K1,1); %MOM区域第m个面片到PO自遮蔽判断亮区的所有面片图心矢量
   CA = CA_MOM(m,:);
   CB = -BC_MOM(m,:);
   for k = 1:K1
       Z_S = [CA' CB' k_i'];   %阻抗矩阵装填
       CQ_k = CQ(k,:)';        %MOM区域第m个面片图心到PO局域未被遮蔽的面片中第k个的矢量
       if((det(Z_S)>0)||(det(Z_S)<0))
           adl=Z_S\CQ_k;
           if(adl(3,1)>=0)
               adl4 = 1-adl(1,1)-adl(2,1);
               if((adl(1,1)>=0&&adl(1,1)<=1)&&(adl(2,1)>=0&&adl(2,1)<=1)&&(adl4>=0&&adl4<=1))
                   sita_PO(sita_1(k,1),1)=0;
               end
           end
       end
   end
end
disp(['PO区域遮蔽判断时间：',num2str(toc),'s']);
sita_PO_MOM = zeros(Edg_MOM_Total,T_NUM_PO);
for i = T_NUM_PO
    center_PO_k = repmat(Center_PO(i,:),Edg_MOM_Total,1);
    cen_d_MOM_PO_k = center_PO_k-dolp_MOM_r0;
    afa_PO_MOM = cen_d_MOM_PO_k*n_i_PO(i,:)';
    sita_PO_MOM_k = afa_PO_MOM<0;
    sita_PO_MOM(:,i)=sita_PO_MOM_k;
end
%%
%散射体表面感应电流和感应磁流
n_i_PO_Plus = n_i_PO(Tri_PO_Plus,:);
n_i_PO_Minus = n_i_PO(Tri_PO_Minus,:);
n_i_PO_PM = (n_i_PO_Plus+n_i_PO_Minus)./repmat(sqrt(sum((n_i_PO_Plus+n_i_PO_Minus).^2,2)),1,3);  %加权法向量
%%
%PO区域电流系数离散
%                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
%tao+和tao-确定
P1_P1 = p_PO(Edge_PO(:,1),:)-p_PO(Edge_PO(:,2),:);
taoA = cross(P1_P1,RHO_PO_Plus);
taoB = cross(P1_P1,RHO_PO_Minus);
taoA1 = -cross(P1_P1,taoA);
taoB1 = -cross(P1_P1,taoB);
tao_z = taoA1./repmat(sqrt(sum(taoA1.^2,2)),1,3); %垂直于公共边的单位法矢
tao_f = taoB1./repmat(sqrt(sum(taoB1.^2,2)),1,3);
tao_zf = (tao_z+tao_f);                       %tao
%  
sita_PO_zf =0.5*(sita_PO(Tri_PO_Plus,1)+sita_PO(Tri_PO_Minus,1));
I_inc_k = sita_PO_zf.*sum(tao_zf.*cross(n_i_PO_PM,H_inc_r_k),2);

FileName1 = 'PO_I_s.mat';
save(FileName1,'sita_PO_MOM','sita_PO','tao_zf','n_i_PO_PM');
FileName2 = 'I_inc_k.mat';
save(FileName2,'I_inc_k');